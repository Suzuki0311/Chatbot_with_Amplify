version: 1
frontend:
  phases:
    build:
      commands:
        - echo "Skipping frontend build"
        - mkdir empty_directory
        - echo "This is a dummy file." > empty_directory/dummy.txt
  artifacts:
    baseDirectory: empty_directory
    files:
      - '**/*'
backend:
  phases:
    preBuild:
      commands:
        - echo "Installing Docker..."
        - curl -L https://download.docker.com/linux/static/stable/x86_64/docker-20.10.7.tgz -o docker.tgz
        - tar xzf docker.tgz
        - mv docker/* /usr/local/bin/
        - rmdir docker
        - rm docker.tgz
        - nohup dockerd > /dev/null 2>&1 &
        - sleep 5
        - curl https://www.python.org/ftp/python/3.8.12/Python-3.8.12.tgz -o python-3.8.tgz
        - tar xzf python-3.8.tgz
        - cd Python-3.8.12
        - ./configure --prefix=$HOME/python3.8
        - make && make install
        - cd ..
        - export PATH=$HOME/python3.8/bin:$PATH
        - pip3 install pipenv
        - pip3 install virtualenv
    build:
      commands:
        - amplifyPush --simple
        - docker build -t pictolang-dev .
        - docker tag pictolang-dev:latest 660988641828.dkr.ecr.ap-northeast-1.amazonaws.com/pictolang-dev:latest
        - aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin 660988641828.dkr.ecr.ap-northeast-1.amazonaws.com
        - docker push 660988641828.dkr.ecr.ap-northeast-1.amazonaws.com/pictolang-dev:latest
        - aws lambda update-function-code --function-name chatGPTLineChatBotFunction-dev --image-uri 660988641828.dkr.ecr.ap-northeast-1.amazonaws.com/pictolang-dev:latest --publish
  artifacts:
    baseDirectory: chatbot_with_amplify/build
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
  runtime-versions:
    python: 3.8